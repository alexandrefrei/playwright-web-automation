name: Feature Branch Testing

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Feature branch to test (e.g., af/newtest/1234-new-feature)'
        required: true
        type: string
      environment:
        description: 'Test environment where feature is deployed'
        required: true
        type: choice
        options:
          - test-environment-1
          - test-environment-2
          - test-environment-3
          - test-environment-4
          - test-environment-5
          - test-environment-6
          - test-environment-7
          - test-environment-8
          - test-environment-9
          - test-environment-10
          - qa
      test_file:
        description: 'Path to test file (e.g., tests/block-question-tests/block-question-checkbox.spec.ts)'
        required: true
        type: string
      default_browser:
        description: 'Browser engine for tests'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  feature-test:
    timeout-minutes: 60
    name: ðŸ§ª Testing ${{ inputs.branch }} on ${{ inputs.environment }}
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout branch ${{ inputs.branch }}
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          lfs: true
      #
      - name: ðŸ“¦ Install dependencies
        run: npm install
      #  
      - name: ðŸ–¥ï¸ Install Playwright Browsers
        run: npx playwright install
      #
      - name: ðŸ§¾ Run test file
        run: |
          echo "ðŸŒ¿ Branch: $BRANCH_NAME"
          echo "ðŸŒ Environment: $ENVIRONMENT"
          echo "ðŸ“„ Test file: $TEST_FILE"
          echo "ðŸŒ Browser: $DEFAULT_BROWSER"

          npx playwright test "$TEST_FILE"
        env:
          BRANCH_NAME: ${{ inputs.branch }}
          ENVIRONMENT: ${{ inputs.environment }}
          TEST_FILE: ${{ inputs.test_file }}
          DEFAULT_BROWSER: ${{ inputs.default_browser }}
      #
      - name: ðŸ“¤ Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.run_number }}
          path: playwright-report/
          retention-days: 7
      #
      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_number }}
          path: test-results/
          retention-days: 7
      #
      - name: ðŸ“Š Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Feature Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ inputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Test File:** \`${{ inputs.test_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Browser:** \`${{ inputs.default_browser }}\`" >> $GITHUB_STEP_SUMMARY
